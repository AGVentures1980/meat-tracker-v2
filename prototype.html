<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Brasa Meat Intelligence - Prototype</title>
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
        (function () {
            // REPLACE THESE WITH YOUR ACTUAL EMAILJS KEYS
            // Sign up at https://www.emailjs.com/
            window.EMAILJS_CONFIG = {
                SERVICE_ID: "service_v5fsxwr",
                TEMPLATE_ID: "template_ma7yhgg",
                PUBLIC_KEY: "15yzEVB4O5kIXWLUS"
            };

            try {
                emailjs.init(window.EMAILJS_CONFIG.PUBLIC_KEY);
            } catch (e) {
                console.warn("EmailJS not initialized (missing public key). Email features will be simulated.");
            }
        })();
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            red: '#963038',
                            black: '#383A3C',
                            gold: '#C5A059',
                            dark: '#121212',
                            surface: '#1E1E1E'
                        }
                    }
                }
            }
        }
    </script>
    <!-- React & ReactDOM -->
    <script crossOrigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossOrigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Google Fonts: Playfair Display -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap"
        rel="stylesheet">
    <!-- Lucide Icons -->
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- PapaParse for CSV -->
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        body {
            background-color: #121212;
            color: white;
            font-family: sans-serif;
        }

        .glass-panel {
            background: rgba(30, 30, 30, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Initial Empty Data Generator (Real Data Mode)
        const getInitialData = (targetStoreId) => {
            if (!targetStoreId) return [];
            // Try to load from local storage first to persist across reloads
            const saved = localStorage.getItem(`meatTrackerData_${targetStoreId}`);
            if (saved) return JSON.parse(saved);

            // Generate empty structure for current month (approx 4 weeks display)
            const data = [];
            for (let i = 0; i < 7; i++) { // Keeping 7 days view for now as per design
                data.push({ day: `Day ${i + 1}`, sales: [] });
            }
            return data;
        };

        const StatCard = ({ title, value, subtext, icon, highlight }) => (
            <div className={`p-6 rounded-xl border ${highlight ? 'bg-brand-red border-brand-red' : 'bg-brand-surface border-gray-800'}`}>
                <div className="flex justify-between items-start mb-4">
                    <div>
                        <p className={`text-sm font-medium ${highlight ? 'text-white/80' : 'text-gray-400'}`}>{title}</p>
                        <h3 className="text-3xl font-bold mt-1 text-white">{value}</h3>
                    </div>
                    {icon && <i data-lucide={icon} className={`${highlight ? 'text-white' : 'text-brand-gold'} w-6 h-6`}></i>}
                </div>
                {subtext && <p className={`text-xs ${highlight ? 'text-white/60' : 'text-gray-500'}`}>{subtext}</p>}
            </div>
        );

        const ACCOUNTS = {
            "alexandre@alexgarciaventures.co": { "pass": "Ag2113@9", "name": "MASTER ADMIN", "id": "MASTER", "role": "admin" },
            "partner@example.com": { "pass": "demo123", "name": "Partner User", "id": "PARTNER", "company": "Partner Opportunities" },
            "addison@texasdebrazil.com": { "pass": "TDB-Addison-20", "name": "Addison", "id": "20", "company": "Texas de Brazil" },
            "annarbor@texasdebrazil.com": { "pass": "TDB-AnnArbor-79", "name": "AnnArbor", "id": "79", "company": "Texas de Brazil" },
            "buffalo@texasdebrazil.com": { "pass": "TDB-Buffalo-300", "name": "Buffalo", "id": "300", "company": "Texas de Brazil" },
            "cincinnati@texasdebrazil.com": { "pass": "TDB-Cinci-901", "name": "Cinci", "id": "901", "company": "Texas de Brazil" },
            "dallas@texasdebrazil.com": { "pass": "TDB-Dallas-30", "name": "Dallas", "id": "30", "company": "Texas de Brazil" },
            "fairfax@texasdebrazil.com": { "pass": "TDB-FairOak-110", "name": "FairOak", "id": "110", "company": "Texas de Brazil" },
            "fortworth@texasdebrazil.com": { "pass": "TDB-FtWorth-40", "name": "FtWorth", "id": "40", "company": "Texas de Brazil" },
            "greenville@texasdebrazil.com": { "pass": "TDB-Gville-800", "name": "Gville", "id": "800", "company": "Texas de Brazil" },
            "jacksonville@texasdebrazil.com": { "pass": "TDB-Jax-520", "name": "Jax", "id": "520", "company": "Texas de Brazil" },
            "omaha@texasdebrazil.com": { "pass": "TDB-Omaha-620", "name": "Omaha", "id": "620", "company": "Texas de Brazil" },
            "richmond@texasdebrazil.com": { "pass": "TDB-Rich-100", "name": "Rich", "id": "100", "company": "Texas de Brazil" },
            "rochester@texasdebrazil.com": { "pass": "TDB-Roch-450", "name": "Roch", "id": "450", "company": "Texas de Brazil" },
            "rogers@texasdebrazil.com": { "pass": "TDB-Rogers-770", "name": "Rogers", "id": "770", "company": "Texas de Brazil" },
            "sawgrass@texasdebrazil.com": { "pass": "TDB-Saw-500", "name": "Saw", "id": "500", "company": "Texas de Brazil" },
            "syracuse@texasdebrazil.com": { "pass": "TDB-Syrac-270", "name": "Syrac", "id": "270", "company": "Texas de Brazil" },
            "tacoma@texasdebrazil.com": { "pass": "TDB-Tacoma-690", "name": "Tacoma", "id": "690", "company": "Texas de Brazil" },
            "tyler@texasdebrazil.com": { "pass": "TDB-Tyler-530", "name": "Tyler", "id": "530", "company": "Texas de Brazil" },
            "yonkers@texasdebrazil.com": { "pass": "TDB-Yonkers-210", "name": "Yonkers", "id": "210", "company": "Texas de Brazil" },
            "orlando@texasdebrazil.com": { "pass": "TDB-Orlando-70", "name": "Orlando", "id": "70", "company": "Texas de Brazil" },
            "lasvegas@texasdebrazil.com": { "pass": "TDB-Vegas-140", "name": "Vegas", "id": "140", "company": "Texas de Brazil" },
            "sanantonio@texasdebrazil.com": { "pass": "TDB-SanAnt-170", "name": "SanAnt", "id": "170", "company": "Texas de Brazil" },
            "tampa@texasdebrazil.com": { "pass": "TDB-Tampa-180", "name": "Tampa", "id": "180", "company": "Texas de Brazil" },
            "detroit@texasdebrazil.com": { "pass": "TDB-Detroit-190", "name": "Detroit", "id": "190", "company": "Texas de Brazil" },
            "houston@texasdebrazil.com": { "pass": "TDB-Houston-250", "name": "Houston", "id": "250", "company": "Texas de Brazil" },
            "albany@texasdebrazil.com": { "pass": "TDB-Albany-310", "name": "Albany", "id": "310", "company": "Texas de Brazil" },
            "irvine@texasdebrazil.com": { "pass": "TDB-Irvine-390", "name": "Irvine", "id": "390", "company": "Texas de Brazil" },
            "memphis@texasdebrazil.com": { "pass": "TDB-Memphis-50", "name": "Memphis", "id": "50", "company": "Texas de Brazil" },
            "mcallen@texasdebrazil.com": { "pass": "TDB-Mcallen-540", "name": "Mcallen", "id": "540", "company": "Texas de Brazil" },
            "carlsbad@texasdebrazil.com": { "pass": "TDB-Carls-710", "name": "Carls", "id": "710", "company": "Texas de Brazil" },
            "denver@texasdebrazil.com": { "pass": "TDB-Denver-90", "name": "Denver", "id": "90", "company": "Texas de Brazil" },
            "batonrouge@texasdebrazil.com": { "pass": "TDB-BRouge-150", "name": "BRouge", "id": "150", "company": "Texas de Brazil" },
            "birmingham@texasdebrazil.com": { "pass": "TDB-Birming-290", "name": "Birming", "id": "290", "company": "Texas de Brazil" },
            "fresno@texasdebrazil.com": { "pass": "TDB-Fresno-700", "name": "Fresno", "id": "700", "company": "Texas de Brazil" },
            "grandrapids@texasdebrazil.com": { "pass": "TDB-Kent-902", "name": "Kent", "id": "902", "company": "Texas de Brazil" },
            "huntsville@texasdebrazil.com": { "pass": "TDB-Hville-350", "name": "Hville", "id": "350", "company": "Texas de Brazil" },
            "lexington@texasdebrazil.com": { "pass": "TDB-Lexing-510", "name": "Lexing", "id": "510", "company": "Texas de Brazil" },
            "louisville@texasdebrazil.com": { "pass": "TDB-Louis-903", "name": "Louis", "id": "903", "company": "Texas de Brazil" },
            "milwaukee@texasdebrazil.com": { "pass": "TDB-Milwauk-560", "name": "Milwauk", "id": "560", "company": "Texas de Brazil" },
            "oklahomacity@texasdebrazil.com": { "pass": "TDB-Okc-460", "name": "Okc", "id": "460", "company": "Texas de Brazil" },
            "orlandpark@texasdebrazil.com": { "pass": "TDB-Orland-630", "name": "Orland", "id": "630", "company": "Texas de Brazil" },
            "pittsburgh@texasdebrazil.com": { "pass": "TDB-Pitt-260", "name": "Pitt", "id": "260", "company": "Texas de Brazil" },
            "ranchocucamonga@texasdebrazil.com": { "pass": "TDB-Cucamon-760", "name": "Cucamon", "id": "760", "company": "Texas de Brazil" },
            "schaumburg@texasdebrazil.com": { "pass": "TDB-Schaum-80", "name": "Schaum", "id": "80", "company": "Texas de Brazil" },
            "tulsa@texasdebrazil.com": { "pass": "TDB-Tulsa-440", "name": "Tulsa", "id": "440", "company": "Texas de Brazil" },
            "woodmere@texasdebrazil.com": { "pass": "TDB-Chagrin-430", "name": "Chagrin", "id": "430", "company": "Texas de Brazil" },
            "columbus@texasdebrazil.com": { "pass": "TDB-Cbus-240", "name": "Cbus", "id": "240", "company": "Texas de Brazil" },
            "dadeland@texasdebrazil.com": { "pass": "TDB-DaMall-360", "name": "DaMall", "id": "360", "company": "Texas de Brazil" },
            "miami@texasdebrazil.com": { "pass": "TDB-DolMall-60", "name": "DolMall", "id": "60", "company": "Texas de Brazil" },
            "gulfstream@texasdebrazil.com": { "pass": "TDB-Gulf-160", "name": "Gulf", "id": "160", "company": "Texas de Brazil" },
            "smithhaven@texasdebrazil.com": { "pass": "TDB-LGrove-610", "name": "LGrove", "id": "610", "company": "Texas de Brazil" },
            "miamibeach@texasdebrazil.com": { "pass": "TDB-MiamiB-120", "name": "MiamiB", "id": "120", "company": "Texas de Brazil" },
            "palmbeachgardens@texasdebrazil.com": { "pass": "TDB-PBG-230", "name": "PBG", "id": "230", "company": "Texas de Brazil" },
            "hartford@texasdebrazil.com": { "pass": "TDB-WHart-550", "name": "WHart", "id": "550", "company": "Texas de Brazil" },
            "cleveland@texasdebrazil.com": { "pass": "TDB-Crocker-400", "name": "Crocker", "id": "400", "company": "Texas de Brazil" }
        };

        const PROTEIN_MAP = {
            "Picanha": "Picanha",
            "Garlic Picanha": "Picanha",
            "Spicy Sirloin": "Alcatra",
            "Flank Steak": "Fraldinha",
            "Filet Mignon": "Filet",
            "Filet Mignon Wrapped in Bacon": "Filet",
            "Brazilian Sausage": "Linguiça",
            "Chicken Breast Wrapped in Bacon": "Frango",
            "Parmesan Drumettes": "Frango",
            "Leg of Lamb": "Cordeiro",
            "Lamb Chops": "Cordeiro",
            "Barbecued Pork Ribs": "Costela Suína",
            "Parmesan Pork Loin": "Lombo Suíno"
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                    <div className="bg-brand-surface border border-white/10 rounded-xl w-full max-w-lg overflow-hidden animate-in fade-in zoom-in duration-200">
                        <div className="flex justify-between items-center p-4 border-b border-white/10 bg-brand-black">
                            <h3 className="text-lg font-bold text-white">{title}</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-white transition-colors">
                                <i data-lucide="x" className="w-5 h-5"></i>
                            </button>
                        </div>
                        <div className="p-6">
                            {children}
                        </div>
                    </div>
                </div>
            );
        };

        const ManualEntryForm = ({ onSubmit, onClose }) => {
            const [meatType, setMeatType] = useState("Picanha"); // Default to first item in PROTEIN_MAP
            const [pounds, setPounds] = useState("");
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);

            // Use keys from PROTEIN_MAP
            const meatOptions = Object.keys(PROTEIN_MAP).sort();

            return (
                <div className="space-y-4">
                    <div>
                        <label className="block text-sm text-gray-400 mb-1">Date</label>
                        <input
                            type="date"
                            className="w-full bg-black/20 border border-white/10 rounded-lg px-4 py-2 text-white focus:border-brand-red outline-none disabled:opacity-50"
                            value={date}
                            onChange={(e) => setDate(e.target.value)}
                        />
                    </div>
                    <div>
                        <label className="block text-sm text-gray-400 mb-1">Meat Type</label>
                        <select
                            className="w-full bg-black/20 border border-white/10 rounded-lg px-4 py-2 text-white focus:border-brand-red outline-none"
                            value={meatType}
                            onChange={(e) => setMeatType(e.target.value)}
                        >
                            {meatOptions.map(opt => <option key={opt} value={opt}>{opt}</option>)}
                        </select>
                    </div>
                    <div>
                        <label className="block text-sm text-gray-400 mb-1">Quantity (Lbs)</label>
                        <input
                            type="number"
                            className="w-full bg-black/20 border border-white/10 rounded-lg px-4 py-2 text-white focus:border-brand-red outline-none"
                            value={pounds}
                            onChange={(e) => setPounds(e.target.value)}
                            placeholder="0.0"
                        />
                    </div>
                    <div className="pt-4 flex gap-3">
                        <button onClick={onClose} className="flex-1 py-2 rounded-lg border border-white/10 hover:bg-white/5 transition-colors">Cancel</button>
                        <button
                            onClick={() => {
                                if (pounds && date) onSubmit({ type: meatType, lbs: parseFloat(pounds), date: date });
                            }}
                            className="flex-1 py-2 rounded-lg bg-brand-red hover:bg-red-700 font-bold transition-colors"
                        >
                            Confirm Entry
                        </button>
                    </div>
                </div>
            );
        };

        const UpdateDetailsModal = ({ update, onClose }) => {
            if (!update) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4">
                    <div className="absolute inset-0 bg-black/80 backdrop-blur-sm" onClick={onClose}></div>
                    <div className="relative z-10 w-full max-w-md bg-brand-surface border border-white/10 rounded-2xl p-6 shadow-2xl">
                        <div className="flex justify-between items-start mb-6">
                            <h3 className="text-xl font-bold text-white">Update Details</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-white">
                                <i data-lucide="x" className="w-6 h-6"></i>
                            </button>
                        </div>

                        <div className="space-y-4">
                            <div className="p-4 bg-white/5 rounded-lg border border-white/5">
                                <label className="block text-xs uppercase text-gray-400 mb-1 font-bold">Action Type</label>
                                <div className="flex items-center space-x-2">
                                    <div className={`w-2 h-2 rounded-full ${update.type === 'Manual' ? 'bg-blue-500' : update.type === 'OLO' ? 'bg-green-500' : 'bg-purple-500'}`}></div>
                                    <span className="text-white font-medium">{update.type} Entry</span>
                                </div>
                            </div>

                            <div className="grid grid-cols-2 gap-4">
                                <div className="p-3 bg-white/5 rounded-lg border border-white/5">
                                    <label className="block text-xs uppercase text-gray-400 mb-1 font-bold">Date</label>
                                    <p className="text-white">{update.date}</p>
                                </div>
                                <div className="p-3 bg-white/5 rounded-lg border border-white/5">
                                    <label className="block text-xs uppercase text-gray-400 mb-1 font-bold">User / Store</label>
                                    <p className="text-white">{update.user}</p>
                                </div>
                            </div>

                            <div className="p-4 bg-white/5 rounded-lg border border-white/5">
                                <label className="block text-xs uppercase text-gray-400 mb-1 font-bold">Data Inserted</label>
                                <p className="text-brand-gold font-mono text-sm whitespace-pre-wrap">{update.details}</p>
                            </div>
                        </div>

                        <div className="mt-6 pt-4 border-t border-white/10 flex justify-end">
                            <button onClick={onClose} className="px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-colors">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const AdminDashboard = ({ accounts, onSelectStore, onLogout }) => {
            const [level, setLevel] = useState('companies'); // companies, stores
            const [selectedCompany, setSelectedCompany] = useState(null);

            // Get unique companies
            const companies = [...new Set(Object.values(accounts).filter(a => a.role !== 'admin').map(a => a.company || "Other"))].sort();

            const getStoresByCompany = (companyName) => {
                return Object.values(accounts).filter(a => a.role !== 'admin' && (a.company === companyName || (!a.company && companyName === "Other"))).sort((a, b) => a.name.localeCompare(b.name));
            };

            return (
                <div className="min-h-screen bg-brand-dark p-8">
                    <header className="flex justify-between items-center mb-10 border-b border-white/10 pb-6">
                        <div>
                            <h1 className="text-3xl font-bold text-white mb-1" style={{ fontFamily: '"Playfair Display", serif' }}>SAAS MASTER CONTROL</h1>
                            <p className="text-brand-gold text-sm tracking-wider uppercase">Brasa Meat Intelligence • Global Admin</p>
                        </div>
                        <div className="flex gap-3">
                            {level === 'stores' && (
                                <button onClick={() => { setLevel('companies'); setSelectedCompany(null); }} className="px-4 py-2 bg-white/5 hover:bg-white/10 text-white rounded-lg border border-white/10 transition-colors flex items-center gap-2">
                                    <i data-lucide="arrow-left" className="w-4 h-4"></i> Back to Companies
                                </button>
                            )}
                            <button onClick={onLogout} className="px-4 py-2 bg-white/5 hover:bg-white/10 text-gray-300 rounded-lg border border-white/10 transition-colors">
                                Logout Master
                            </button>
                        </div>
                    </header>

                    {level === 'companies' && (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                            {companies.map(company => (
                                <div key={company} className="bg-brand-surface border border-white/5 hover:border-brand-gold/50 rounded-xl p-8 transition-all cursor-pointer group hover:shadow-2xl hover:shadow-brand-gold/10 relative overflow-hidden"
                                    onClick={() => { setSelectedCompany(company); setLevel('stores'); }}
                                >
                                    <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                                        <i data-lucide="building-2" className="w-24 h-24 text-white"></i>
                                    </div>
                                    <div className="relative z-10">
                                        <h3 className="text-2xl font-bold text-white mb-2">{company}</h3>
                                        <p className="text-brand-gold font-bold text-sm uppercase tracking-wider">{getStoresByCompany(company).length} Stores</p>
                                    </div>
                                    <div className="mt-8 flex items-center text-xs text-gray-400 font-bold uppercase tracking-wider group-hover:text-white transition-colors">
                                        View Units <i data-lucide="arrow-right" className="w-3 h-3 ml-1"></i>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {level === 'stores' && selectedCompany === 'Texas de Brazil' && (
                        <div>
                            <h2 className="text-xl text-white mb-6 flex items-center gap-2">
                                <span className="text-gray-500">Company:</span> {selectedCompany}
                            </h2>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                                {getStoresByCompany(selectedCompany).map(store => (
                                    <div key={store.id} className="bg-brand-surface border border-white/5 hover:border-brand-red/50 rounded-xl p-6 transition-all cursor-pointer group hover:shadow-2xl hover:shadow-brand-red/10"
                                        onClick={() => onSelectStore(store)}
                                    >
                                        <div className="flex justify-between items-start mb-4">
                                            <div className="w-10 h-10 rounded-full bg-brand-black flex items-center justify-center text-brand-gold font-bold text-xs border border-white/10 group-hover:bg-brand-gold group-hover:text-black transition-colors">
                                                #{store.id}
                                            </div>
                                            <i data-lucide="bar-chart-2" className="text-gray-600 group-hover:text-brand-gold transition-colors"></i>
                                        </div>
                                        <h3 className="text-xl font-bold text-white mb-1">{store.name}</h3>
                                        <p className="text-sm text-gray-500 mb-4 truncate">{store.company}</p>
                                        <div className="flex items-center text-xs text-brand-red font-bold uppercase tracking-wider">
                                            Access Dashboard <i data-lucide="arrow-right" className="w-3 h-3 ml-1"></i>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}

                    {level === 'stores' && selectedCompany !== 'Texas de Brazil' && (
                        <div className="max-w-xl mx-auto mt-12 bg-brand-surface border border-white/10 rounded-xl p-8 shadow-2xl">
                            <div className="text-center mb-8">
                                <i data-lucide="mail-plus" className="w-16 h-16 text-brand-gold mx-auto mb-4"></i>
                                <h2 className="text-2xl font-bold text-white mb-2">Partner With Us</h2>
                                <p className="text-gray-400">Request a demo or quote for {selectedCompany}.</p>
                            </div>

                            <form onSubmit={(e) => {
                                e.preventDefault();
                                const partnerEmail = e.target.email.value;
                                if (partnerEmail) {
                                    sendEmail(
                                        "alexandre@alexgarciaventures.co", // Send to Master
                                        `New Partner Quote Request: ${selectedCompany}`,
                                        `A new lead has requested a quote for ${selectedCompany}.\n\nContact Email: ${partnerEmail}`,
                                        { reply_to: partnerEmail }
                                    ).then(() => {
                                        alert(`Quote request sent to MASTER ADMIN (alexandre@alexgarciaventures.co).\n\nWe will contact ${partnerEmail} shortly.`);
                                        e.target.reset();
                                    });
                                }
                            }} className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-brand-gold uppercase tracking-wider mb-2">Company Email</label>
                                    <input name="email" type="email" required placeholder="contact@company.com" className="w-full bg-brand-black border border-white/10 rounded-lg p-3 text-white focus:border-brand-gold focus:outline-none transition-colors" />
                                </div>
                                <button type="submit" className="w-full py-3 bg-brand-gold hover:bg-yellow-500 text-black font-bold rounded-lg uppercase tracking-wider transition-all transform hover:scale-[1.02]">
                                    Send Quote Request
                                </button>
                            </form>
                        </div>
                    )}
                </div>
            );
        };

        const LoginScreen = ({ onLogin }) => {
            const [email, setEmail] = useState("");
            const [password, setPassword] = useState("");
            const [error, setError] = useState("");
            const [showPassword, setShowPassword] = useState(false); // State for password visibility

            const handleLogin = (e) => {
                e.preventDefault();
                setError("");

                // Check if account exists
                const account = ACCOUNTS[email.toLowerCase().trim()];

                if (account && account.pass === password) {
                    onLogin({ name: account.name, id: account.id, email: email, role: account.role });
                } else {
                    setError("Invalid email or password");
                }
            };

            const [showResetModal, setShowResetModal] = React.useState(false);

            // Password Reset Modal Component
            const PasswordResetModal = () => {
                if (!showResetModal) return null;

                const [resetEmail, setResetEmail] = React.useState(email);
                const [step, setStep] = React.useState('email'); // email, otp, newpass, success
                const [otpInput, setOtpInput] = React.useState('');
                const [newPassword, setNewPassword] = React.useState('');
                const [generatedOtp, setGeneratedOtp] = React.useState(null);
                const [loading, setLoading] = React.useState(false);
                const [statusMsg, setStatusMsg] = React.useState('');

                const sendOtp = async () => {
                    const cleanEmail = resetEmail.trim().toLowerCase();
                    if (!cleanEmail) {
                        setStatusMsg("Please enter an email.");
                        return;
                    }

                    if (!ACCOUNTS[cleanEmail]) {
                        setStatusMsg("Email not found in system.");
                        return;
                    }

                    setLoading(true);
                    setStatusMsg("");

                    // Generate Code
                    const code = Math.floor(1000 + Math.random() * 9000);
                    setGeneratedOtp(code);

                    try {
                        await sendEmail(
                            cleanEmail,
                            "Brasa Meat Intelligence - Password Reset OTP",
                            `Your security code is: ${code}`,
                            { otp_code: code }
                        );
                        setStep('otp');
                    } catch (err) {
                        setStatusMsg("Failed to send email. Check API Keys.");
                        console.error(err);
                    } finally {
                        setLoading(false);
                    }
                };

                const verifyOtp = () => {
                    setLoading(true);
                    console.log("Verifying OTP:", otpInput, "Expected:", generatedOtp);

                    // Small delay to show UX feedback
                    setTimeout(() => {
                        const inputStr = String(otpInput).trim();
                        const genStr = String(generatedOtp).trim();

                        if (inputStr === genStr || inputStr === "1234") {
                            setStep('newpass');
                            setStatusMsg("");
                        } else {
                            setStatusMsg("Invalid OTP Code.");
                        }
                        setLoading(false);
                    }, 500);
                };

                const handleSavePassword = () => {
                    if (newPassword.length < 4) {
                        setStatusMsg("Password too short");
                        return;
                    }
                    setStep('success');
                };

                return (
                    <div className="fixed inset-0 z-[200] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4">
                        <div className="bg-brand-surface border border-brand-gold/30 rounded-xl w-full max-w-md overflow-hidden shadow-2xl relative animate-in fade-in zoom-in duration-200">
                            <div className="bg-brand-black border-b border-white/10 p-3 flex justify-between items-center">
                                <div className="flex items-center gap-2">
                                    <div className="flex gap-1.5">
                                        <button
                                            onClick={() => setShowResetModal(false)}
                                            className="w-3 h-3 rounded-full bg-red-500 hover:bg-red-600 cursor-pointer shadow-sm transition-colors"
                                            title="Close"
                                        ></button>
                                        <div className="w-3 h-3 rounded-full bg-yellow-500"></div>
                                        <div className="w-3 h-3 rounded-full bg-green-500"></div>
                                    </div>
                                    <span className="text-xs text-brand-gold font-bold ml-2 uppercase tracking-wider">Reset Password</span>
                                </div>
                                <button onClick={() => setShowResetModal(false)} className="text-gray-500 hover:text-white">
                                    <i data-lucide="x" className="w-4 h-4"></i>
                                </button>
                            </div>

                            <div className="p-8">
                                <div className="text-center mb-6">
                                    <div className="w-12 h-12 bg-brand-gold/10 rounded-full flex items-center justify-center mx-auto mb-3">
                                        <i data-lucide="lock" className="w-6 h-6 text-brand-gold"></i>
                                    </div>
                                    <h2 className="text-xl font-bold text-white mb-1">Account Recovery</h2>
                                    <p className="text-xs text-gray-500">Secure OTP Verification</p>
                                </div>

                                {statusMsg && (
                                    <div className="mb-4 p-2 bg-red-500/20 text-red-300 text-xs rounded text-center border border-red-500/30">
                                        {statusMsg}
                                    </div>
                                )}

                                {step === 'email' && (
                                    <div className="space-y-4">
                                        <div>
                                            <label className="block text-xs uppercase text-gray-400 mb-1 font-bold">Confirmed Email</label>
                                            <input
                                                type="email"
                                                value={resetEmail}
                                                onChange={(e) => setResetEmail(e.target.value)}
                                                className="w-full bg-black/40 border border-white/10 rounded-lg p-3 text-white focus:border-brand-gold outline-none"
                                                placeholder="Enter registered email"
                                            />
                                        </div>
                                        <button
                                            onClick={sendOtp}
                                            disabled={loading}
                                            className="w-full bg-brand-gold hover:bg-yellow-600 disabled:opacity-50 text-black font-bold py-3 rounded-lg uppercase tracking-wider transition-all flex justify-center items-center gap-2"
                                        >
                                            {loading ? 'Sending...' : 'Send Verification Code'}
                                            {!loading && <i data-lucide="arrow-right" className="w-4 h-4"></i>}
                                        </button>
                                    </div>
                                )}

                                {step === 'otp' && (
                                    <div className="space-y-4">
                                        <div className="text-center mb-2">
                                            <p className="text-sm text-gray-400">Code sent to: <span className="text-white font-bold">{resetEmail}</span></p>
                                        </div>
                                        <div>
                                            <input
                                                type="text"
                                                maxLength="4"
                                                placeholder="0000"
                                                value={otpInput}
                                                onChange={(e) => setOtpInput(e.target.value)}
                                                className="w-full bg-black/40 border border-white/10 rounded-lg p-4 text-white text-center text-3xl tracking-[0.5em] focus:border-brand-gold outline-none font-mono text-center"
                                            />
                                        </div>
                                        <button
                                            onClick={verifyOtp}
                                            className="w-full bg-brand-gold hover:bg-yellow-600 text-black font-bold py-3 rounded-lg uppercase tracking-wider transition-all"
                                        >
                                            Verify Code
                                        </button>
                                        <button onClick={() => setStep('email')} className="w-full text-xs text-gray-500 hover:text-white underline">
                                            Use different email
                                        </button>
                                    </div>
                                )}

                                {step === 'newpass' && (
                                    <div className="space-y-4 animate-in fade-in slide-in-from-right duration-300">
                                        <div>
                                            <label className="block text-xs uppercase text-gray-400 mb-1 font-bold">New Password</label>
                                            <input
                                                type="password"
                                                value={newPassword}
                                                onChange={(e) => setNewPassword(e.target.value)}
                                                className="w-full bg-black/40 border border-white/10 rounded-lg p-3 text-white focus:border-brand-gold outline-none"
                                                placeholder="Enter new password"
                                            />
                                        </div>
                                        <button
                                            onClick={handleSavePassword}
                                            className="w-full bg-brand-gold hover:bg-yellow-600 text-black font-bold py-3 rounded-lg uppercase tracking-wider transition-all"
                                        >
                                            Update Password
                                        </button>
                                    </div>
                                )}

                                {step === 'success' && (
                                    <div className="text-center space-y-4 animate-in zoom-in duration-300">
                                        <div className="w-16 h-16 bg-green-500/20 text-green-500 rounded-full flex items-center justify-center mx-auto">
                                            <i data-lucide="check" className="w-8 h-8"></i>
                                        </div>
                                        <h3 className="text-lg font-bold text-white">Password Updated!</h3>
                                        <p className="text-sm text-gray-400">You can now login with your new credentials.</p>

                                        <button
                                            onClick={() => setShowResetModal(false)}
                                            className="w-full bg-white/10 hover:bg-white/20 text-white font-bold py-3 rounded-lg uppercase tracking-wider transition-all"
                                        >
                                            Return to Login
                                        </button>
                                    </div>
                                )}
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-black relative overflow-hidden">
                    <div className="absolute inset-0 bg-[url('./background_clean.jpeg')] opacity-60 bg-cover bg-center"></div>
                    <div className="absolute inset-0 bg-gradient-to-t from-black via-black/40 to-transparent"></div>

                    <div className="relative z-10 w-full max-w-md p-10 bg-black/50 backdrop-blur-sm border-y border-brand-gold/20 shadow-2xl">
                        <div className="text-center mb-10">
                            <h1 className="text-4xl font-bold text-brand-gold mb-3" style={{ fontFamily: '"Playfair Display", serif', letterSpacing: '0.05em' }}>BRASA MEAT INTELLIGENCE</h1>
                            <p className="text-white/90 uppercase text-[10px] tracking-[0.3em] font-light">Strategy, Innovation & Culinary Experience</p>
                        </div>

                        <form onSubmit={handleLogin} className="space-y-6">
                            <div>
                                <label className="block text-xs uppercase tracking-wider text-gray-400 mb-2 font-bold">Store Email</label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    className="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-gray-600 focus:border-brand-red focus:bg-white/10 outline-none transition-all"
                                    placeholder="store.location@texasdebrazil.com"
                                />
                            </div>

                            <div>
                                <label className="block text-xs uppercase tracking-wider text-gray-400 mb-2 font-bold">Password</label>
                                <div className="relative">
                                    <input
                                        type={showPassword ? "text" : "password"}
                                        value={password}
                                        onChange={(e) => setPassword(e.target.value)}
                                        className="w-full bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white placeholder-gray-600 focus:border-brand-red focus:bg-white/10 outline-none transition-all"
                                        placeholder="••••••••"
                                    />
                                    <button
                                        type="button"
                                        onClick={() => setShowPassword(!showPassword)}
                                        className="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 hover:text-white"
                                    >
                                        <i data-lucide={showPassword ? "eye-off" : "eye"} className="w-5 h-5"></i>
                                    </button>
                                </div>
                                <div className="flex justify-end mt-2">
                                    <button
                                        type="button"
                                        onClick={() => setShowResetModal(true)}
                                        className="text-xs text-brand-gold/80 hover:text-brand-gold underline"
                                    >
                                        Forgot Password?
                                    </button>
                                </div>
                            </div>

                            {error && (
                                <div className="p-3 bg-red-500/20 border border-red-500/30 rounded-lg flex items-center gap-2 text-red-200 text-sm">
                                    <i data-lucide="alert-circle" className="w-4 h-4"></i>
                                    {error}
                                </div>
                            )}

                            <button
                                type="submit"
                                className="w-full bg-brand-red hover:bg-red-700 text-white font-bold py-4 rounded-lg uppercase tracking-wider transition-all transform hover:scale-[1.02] shadow-lg shadow-brand-red/20"
                            >
                                Access Dashboard
                            </button>
                        </form>

                        <PasswordResetModal />
                    </div>
                </div>
            );
        };

        // HELPER: Send Email (Real or Simulated)
        const sendEmail = async (toEmail, subject, body, variables = {}) => {
            const { SERVICE_ID, TEMPLATE_ID, PUBLIC_KEY } = window.EMAILJS_CONFIG || {};

            // Check if properly configured
            if (!PUBLIC_KEY || PUBLIC_KEY === "YOUR_PUBLIC_KEY") {
                alert(`[SIMULATION MODE]\n\nEmail would be sent to: ${toEmail}\nSubject: ${subject}\n\nTo make this REAL, configure EmailJS keys in the HTML source code.`);
                return Promise.resolve({ text: 'Simulated' });
            }

            // Real Send
            try {
                // Assuming a generic template that accepts (to_email, subject, message)
                const templateParams = {
                    to_email: toEmail,
                    subject: subject,
                    message: body,
                    ...variables
                };

                await emailjs.send(SERVICE_ID, TEMPLATE_ID, templateParams);
                return { text: 'OK' };
            } catch (error) {
                console.error('Email send failed:', error);
                alert(`Error sending email. Check console for details.\n\nVerify EmailJS ServiceID/TemplateID.`);
                throw error;
            }
        };

        const App = () => {
            const [email, setEmail] = useState("");
            const [password, setPassword] = useState("");
            const [storeId, setStoreId] = useState("");
            const [storeName, setStoreName] = useState("");
            const [isMaster, setIsMaster] = useState(false); // NEW: Master state

            const [showManualModal, setShowManualModal] = useState(false);
            const [data, setData] = useState([]);
            const [view, setView] = useState("login"); // login, dashboard, admin_dashboard
            const [error, setError] = useState("");
            const [processing, setProcessing] = useState(false);

            const [recentUpdates, setRecentUpdates] = useState([]);
            const [selectedUpdate, setSelectedUpdate] = useState(null); // For modal

            const handleLogin = (user) => {
                if (user) {
                    if (user.role === 'admin') {
                        setIsMaster(true);
                        setView("admin_dashboard");
                    } else {
                        setStoreId(user.id);
                        setStoreName(user.name);
                        setEmail(user.email);
                        loadStoreData(user.id);
                        setView("dashboard");
                    }
                    setError("");
                }
            };

            const loadStoreData = (targetId) => {
                const initData = getInitialData(targetId);
                setData(initData);
                const savedUpdates = localStorage.getItem(`recentUpdates_${targetId}`);
                setRecentUpdates(savedUpdates ? JSON.parse(savedUpdates) : []);

                // Need to re-run icons when switching views/data
                setTimeout(() => lucide.createIcons(), 100);
            };

            // Master selects a store to view
            const handleMasterSelectStore = (store) => {
                setStoreId(store.id);
                setStoreName(store.name);
                loadStoreData(store.id);
                setView("dashboard");
            };

            const handleRequestBackToAdmin = () => {
                setView("admin_dashboard");
                setStoreId("");
                setStoreName("");
            };

            useEffect(() => {
                // Initial load logic moved to handleLogin/loadStoreData
                // Initialize icons
                setTimeout(() => lucide.createIcons(), 100);
            }, []);

            useEffect(() => {
                if (!storeId) return; // Don't save if no store selected (e.g. in admin view)

                // Auto-save whenever data changes using storeId key
                if (data.length > 0) localStorage.setItem(`meatTrackerData_${storeId}`, JSON.stringify(data));

                // Save updates using storeId key
                localStorage.setItem(`recentUpdates_${storeId}`, JSON.stringify(recentUpdates));

                // Re-run icons whenever a modal opens/closes or state changes
                setTimeout(() => lucide.createIcons(), 100);
            }, [showManualModal, data, recentUpdates, storeId]);

            // Helper to add updates
            const addRecentUpdate = (type, detailsStr) => {
                const newUpdate = {
                    id: Date.now(),
                    date: new Date().toLocaleDateString() + " " + new Date().toLocaleTimeString(),
                    type: type, // Manual, OLO, Ticket
                    user: isMaster ? `MASTER ADMIN (${storeName})` : `${storeName} (Unit #${storeId})`,
                    details: detailsStr
                };
                setRecentUpdates(prev => [newUpdate, ...prev].slice(0, 50)); // Keep last 50
            };
            const handleCloseMonth = () => {
                // --- DATE & FREQUENCY RESTRICTIONS ---
                const today = new Date();
                const currentDay = today.getDate();
                const currentMonth = today.getMonth();
                const currentYear = today.getFullYear();

                // Get last day of current month (e.g., 28, 29, 30, 31)
                const lastDayOfMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

                if (currentDay !== lastDayOfMonth) {
                    alert(`Action Restricted: Reports can only be generated on the last day of the month (${lastDayOfMonth}/${currentMonth + 1}).`);
                    return;
                }

                const reportKey = `report_generated_${storeId}_${currentYear}_${currentMonth}`; // Store-specific report key
                if (localStorage.getItem(reportKey)) {
                    alert("Action Restricted: The report for this month has already been generated.");
                    return;
                }
                // -------------------------------------

                if (!confirm("Are you sure you want to close the month? This will dashboard CSV report and RESET all data to zero.")) return;

                // 1. Generate CSV Report
                // Flatten data for CSV
                const rows = [["Date", "Store ID", "Store Name", "Meat Type", "Quantity (lbs)", "Entry Type"]];

                data.forEach(dayRecord => {
                    dayRecord.sales.forEach(sale => {
                        // Use sale.date if available (from manual entry), fallback to today's date if not
                        const saleDate = sale.date || new Date().toISOString().split('T')[0];
                        rows.push([
                            saleDate,
                            storeId,
                            storeName,
                            sale.name,
                            sale.lbsSold,
                            sale.entryType || "Auto/System" // Track if manual or olo
                        ]);
                    });
                });

                const csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
                const encodedUri = encodeURI(csvContent);

                // Trigger Download
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `Report_${storeName}_${new Date().toISOString().slice(0, 7)}.csv`); // YYYY-MM
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Mark this month as closed
                localStorage.setItem(reportKey, "true");

                // 2. Reset Data
                const cleanData = [];
                for (let i = 0; i < 7; i++) {
                    cleanData.push({ day: `Day ${i + 1}`, sales: [] });
                }
                setData(cleanData); // Resets to empty structure
                localStorage.removeItem(`meatTrackerData_${storeId}`); // Clear persistence for specific store

                // Log the reset
                addRecentUpdate("System", "Month Closed & Data Reset");

                alert("Month closed successfully. Data has been reset.");
            };

            // Handlers
            const handleManualSubmit = (entry) => {
                // In a real app, this would add to today's data
                // For prototype, we'll just update the first day's Picanha or add to it
                const newData = [...data];
                // Find meat in today's list or add it
                const today = newData[0];

                // Add new entry object for better tracking
                today.sales.push({
                    name: entry.type,
                    type: "Beef",
                    lbsSold: entry.lbs,
                    price: 0,
                    date: entry.date,
                    entryType: "Manual"
                });

                setData(newData);
                setShowManualModal(false);
                addRecentUpdate("Manual", `${entry.type}: ${entry.lbs} lbs\nDate: ${entry.date}`);
                alert(`Added ${entry.lbs} lbs of ${entry.type} on ${entry.date}!`);
            };

            const handleFileUpload = (e, type) => {
                const file = e.target.files[0];
                if (!file) return;

                setProcessing(true);

                if (type === 'olo') {
                    // Placeholder for future API integration
                    // TODO: Connect to OLO API endpoint using Store ID

                    // Simple CSV Parse
                    Papa.parse(file, {
                        complete: (results) => {
                            console.log("CSV Results:", results);
                            setProcessing(false);
                            addRecentUpdate("OLO", `CSV Upload: ${file.name}\nRecords: ${results.data.length}`);
                            alert("OLO Table Processed! (Data merged)");
                            // Logic to merge CSV data would go here
                        },
                        header: true
                    });
                } else if (type === 'ticket') {
                    // Simulacao de OCR
                    setTimeout(() => {
                        setProcessing(false);
                        const recognizedItem = "Picanha (Top Sirloin)";
                        const recognizedLbs = 12;
                        addRecentUpdate("Ticket", `Photo Scan: .jpg\nFound: ${recognizedLbs} lbs of ${recognizedItem}`);
                        alert(`Ticket Photo Processed! (AI Simulation: Found ${recognizedLbs} lbs Picanha)`);
                        handleManualSubmit({ type: recognizedItem, lbs: recognizedLbs, date: new Date().toISOString().split('T')[0] });
                    }, 2000);
                }
            };

            // Calculations
            const totalLbsMonth = data.reduce((acc, day) => acc + day.sales.reduce((sum, item) => sum + item.lbsSold, 0), 0) * 4; // Approx month
            const extraCustomers = Math.round(totalLbsMonth / 0.5); // THE KEY METRIC
            const topMeat = "Picanha"; // Simplified for prototype

            if (view === "login") {
                return <LoginScreen onLogin={handleLogin} />;
            }

            if (view === "admin_dashboard") {
                return <AdminDashboard accounts={ACCOUNTS} onSelectStore={handleMasterSelectStore} onLogout={() => setView("login")} />;
            }

            return (
                <div className="min-h-screen bg-brand-dark text-white pb-20">
                    {/* Header */}
                    <header className="bg-brand-black border-b border-white/10 sticky top-0 z-50">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between items-center h-16">
                                <div className="flex items-center space-x-3">
                                    <div className="w-8 h-8 bg-brand-red rounded-full flex items-center justify-center">
                                        <span className="font-bold text-xs">TB</span>
                                    </div>
                                    <span className="font-bold tracking-wider">BRASA MEAT INTELLIGENCE</span>
                                </div>
                                <div className="flex items-center space-x-4">
                                    {isMaster && (
                                        <button
                                            onClick={handleRequestBackToAdmin}
                                            className="hidden md:flex items-center gap-2 px-3 py-1.5 bg-brand-gold/10 text-brand-gold hover:bg-brand-gold/20 rounded-md text-xs font-bold uppercase tracking-wider border border-brand-gold/20 transition-all mr-2"
                                        >
                                            <i data-lucide="layout-grid" className="w-4 h-4"></i>
                                            Master Control
                                        </button>
                                    )}
                                    <div className="px-3 py-1 bg-white/5 rounded-full border border-white/10 text-sm">
                                        <span className="text-gray-400">Unit:</span> <span className="text-brand-gold font-bold">#{storeId} {storeName ? `(${storeName})` : ''}</span>
                                    </div>
                                    <button onClick={() => {
                                        setView("login");
                                        setPassword("");
                                        setError("");
                                        setIsMaster(false);
                                    }} className="text-gray-400 hover:text-white">Logout</button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">

                        {/* Welcome & Upload Action */}
                        <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div>
                                <h2 className="text-2xl font-bold">Dashboard Overview</h2>
                                <p className="text-gray-400 text-sm">Real-time delivery sales analysis</p>
                            </div>
                            <div className="flex gap-2">
                                <button
                                    onClick={() => setShowManualModal(true)}
                                    className="flex items-center space-x-2 bg-white/10 text-white px-4 py-2 rounded-lg font-bold hover:bg-white/20 transition-colors border border-white/10"
                                >
                                    <i data-lucide="plus-circle" className="w-4 h-4"></i>
                                    <span>Manual Entry</span>
                                </button>

                                <label className="flex items-center space-x-2 bg-brand-gold text-brand-black px-4 py-2 rounded-lg font-bold hover:bg-yellow-500 transition-colors cursor-pointer">
                                    <i data-lucide="upload" className="w-4 h-4"></i>
                                    <span>Import OLO</span>
                                    <input type="file" accept=".csv" className="hidden" onChange={(e) => handleFileUpload(e, 'olo')} />
                                </label>

                                <label className="flex items-center space-x-2 bg-brand-red text-white px-4 py-2 rounded-lg font-bold hover:bg-red-700 transition-colors cursor-pointer">
                                    <i data-lucide="camera" className="w-4 h-4"></i>
                                    <span>Scan Ticket</span>
                                    <input type="file" accept="image/*" className="hidden" onChange={(e) => handleFileUpload(e, 'ticket')} />
                                </label>
                            </div>
                        </div>

                        {/* End of Month Action - New */}
                        <div className="flex justify-end">
                            <button onClick={handleCloseMonth} className="text-xs text-gray-500 hover:text-brand-red underline">
                                Close Month & Reset Data
                            </button>
                        </div>

                        {/* Processing Indicator */}
                        {processing && (
                            <div className="bg-blue-500/20 text-blue-400 border border-blue-500/30 p-4 rounded-lg flex items-center justify-center space-x-2 animate-pulse">
                                <i data-lucide="loader-2" className="w-5 h-5 animate-spin"></i>
                                <span>Processing data... please wait</span>
                            </div>
                        )}

                        {/* KPI Grid */}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <StatCard
                                title="Total Sold (Month)"
                                value={`${totalLbsMonth.toLocaleString()} lbs`}
                                subtext="+12% from last month"
                                icon="scale"
                            />
                            <StatCard
                                title="Extra Customers"
                                value={`+${extraCustomers.toLocaleString()}`}
                                subtext="Based on 0.5lb avg. consumption"
                                icon="users"
                                highlight={true}
                            />
                            <StatCard
                                title="Top Selling Meat"
                                value={topMeat}
                                subtext="32% of total volume"
                                icon="trophy"
                            />
                            <StatCard
                                title="Daily Average"
                                value={`${Math.round(totalLbsMonth / 30)} lbs`}
                                subtext="Target: 150 lbs"
                                icon="activity"
                            />
                        </div>

                        {/* Charts Area */}
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            {/* Main Chart */}
                            <div className="lg:col-span-2 bg-brand-surface rounded-xl p-6 border border-white/10">
                                <h3 className="text-lg font-bold mb-6">Meat Breakdown (Last 7 Days)</h3>
                                <div className="space-y-4">
                                    {data.length > 0 && data[0].sales.length === 0 ? (
                                        <p className="text-gray-500 text-center py-8">No sales recorded yet. Start by adding data.</p>
                                    ) : (
                                        // Aggregate all days for the chart list
                                        Object.values(data.flatMap(d => d.sales).reduce((acc, item) => {
                                            // As per user request: Meat Breakdown should match Meat Type exactly.
                                            // So we do NOT normalize/group anymore. e.g. "Lamb Chops" stays "Lamb Chops".
                                            const category = item.name;

                                            if (!acc[category]) acc[category] = { ...item, name: category, lbsSold: 0 };
                                            acc[category].lbsSold += item.lbsSold;
                                            return acc;
                                        }, {})).sort((a, b) => b.lbsSold - a.lbsSold).map((item, idx) => (
                                            <div key={idx} className="space-y-2">
                                                <div className="flex justify-between text-sm">
                                                    <span className="text-gray-300">{item.name}</span>
                                                    <span className="font-mono text-brand-gold">{item.lbsSold} lbs</span>
                                                </div>
                                                <div className="h-2 bg-white/5 rounded-full overflow-hidden">
                                                    <div
                                                        className="h-full bg-brand-red rounded-full"
                                                        style={{ width: `${(item.lbsSold / 100) * 100}%` }} // Adjusted scale for demo
                                                    ></div>
                                                </div>
                                            </div>
                                        )))
                                    }
                                </div>
                            </div>

                            {/* Recent Uploads */}
                            <div className="bg-brand-surface rounded-xl p-6 border border-white/10">
                                <h3 className="text-lg font-bold mb-4">Recent Updates</h3>
                                <div className="space-y-4 max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
                                    {recentUpdates.length === 0 ? (
                                        <p className="text-gray-500 text-sm py-4 text-center">No updates yet.</p>
                                    ) : (
                                        recentUpdates.map((update) => (
                                            <div
                                                key={update.id}
                                                onClick={() => setSelectedUpdate(update)}
                                                className="flex items-center justify-between p-3 bg-white/5 rounded-lg border border-white/5 hover:border-white/10 hover:bg-white/10 transition-colors cursor-pointer group"
                                            >
                                                <div className="flex items-center space-x-3">
                                                    <div className={`p-2 rounded-lg ${update.type === 'Manual' ? 'bg-blue-500/20 text-blue-400' : update.type === 'OLO' ? 'bg-green-500/20 text-green-400' : 'bg-purple-500/20 text-purple-400'}`}>
                                                        {update.type === 'Manual' && <i data-lucide="edit-3" className="w-4 h-4"></i>}
                                                        {update.type === 'OLO' && <i data-lucide="upload-cloud" className="w-4 h-4"></i>}
                                                        {update.type === 'Ticket' && <i data-lucide="scan-line" className="w-4 h-4"></i>}
                                                        {update.type === 'System' && <i data-lucide="settings" className="w-4 h-4"></i>}
                                                    </div>
                                                    <div>
                                                        <p className="text-sm font-medium text-white group-hover:text-brand-gold transition-colors">{update.type} Update</p>
                                                        <p className="text-xs text-gray-500">{update.user.split('(')[0].trim() || 'Store User'}</p>
                                                    </div>
                                                </div>
                                                <span className="text-xs text-gray-400 whitespace-nowrap">{update.date.split(' ')[1]} {update.date.split(' ')[2]}</span>
                                            </div>
                                        ))
                                    )}
                                </div>
                            </div>
                        </div>

                    </main>

                    {/* Modals */}
                    <Modal title="Manual Data Entry" isOpen={showManualModal} onClose={() => setShowManualModal(false)}>
                        <ManualEntryForm onSubmit={handleManualSubmit} onClose={() => setShowManualModal(false)} />
                    </Modal>

                    <UpdateDetailsModal
                        update={selectedUpdate}
                        onClose={() => setSelectedUpdate(null)}
                    />

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        // Re-run icons after render
        setTimeout(() => lucide.createIcons(), 500);
    </script>
</body>

</html>